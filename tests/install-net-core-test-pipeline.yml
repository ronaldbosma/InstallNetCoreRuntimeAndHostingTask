# This pipeline is used to test the custom InstallNetCoreRuntimeAndHosting task.
#
# This pipeline:
# - provisions a server in Azure and registers it in an Azure Pipelines environment
# - install all version of the .NET Core Runtime & Hosting bundle on the server and verify that it was successful
# - unregister the server from the Azure Pipelines environment and remove the Azure resource group
# 
# The following variables need to be provided to the pipeline:
# - Token         : a Personal Access Token with the scope 'Environment (Read & manage)'.
# - AdminPassword : a password for the Admin user of the provisioned Azure server.


trigger: none


variables:
  azureSubscription: 'Azure Visual Studio Enterprise'
  environmentName: 'net-core-test-$(Build.BuildNumber)'


stages:
- stage: 'ProvisionTestEnvironment'
  jobs:
  - job:
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Provision and register Azure VM'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: pscore
        scriptPath: './tests/scripts/provision-azure-vm.ps1'
        arguments:
          -AdminPassword '$(AdminPassword)' `
          -OrganizationUrl '$(System.CollectionUri)' `
          -TeamProject '$(System.TeamProject)' `
          -Environment '$(environmentName)' `
          -Token '$(Token)'


- stage: 'InstallNetCore'
  dependsOn: 'ProvisionTestEnvironment'
  condition: succeeded()
  jobs:
  - deployment: 'InstallNetCore'
    environment:
      name: '$(environmentName)'
      resourceType: 'VirtualMachine'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: 'templates/execute-and-assert-installnetcoreruntimeandhosting-task.yml'
            parameters:
              dotNetVersion: '2.1'
          - template: 'templates/execute-and-assert-installnetcoreruntimeandhosting-task.yml'
            parameters:
              dotNetVersion: '2.2'
          - template: 'templates/execute-and-assert-installnetcoreruntimeandhosting-task.yml'
            parameters:
              dotNetVersion: '3.0'
          - template: 'templates/execute-and-assert-installnetcoreruntimeandhosting-task.yml'
            parameters:
              dotNetVersion: '3.1'
          - template: 'templates/execute-and-assert-installnetcoreruntimeandhosting-task.yml'
            parameters:
              dotNetVersion: '5.0'


- stage: 'DeleteTestServer'
  dependsOn: 'InstallNetCore'
  condition: succeeded()
  jobs:
  - job:
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Unregister And delete Azure VM'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: pscore
        scriptPath: './tests/scripts/delete-azure-vms.ps1'
        arguments:
          -Environment '$(environmentName)' `
          -Token '$(Token)'