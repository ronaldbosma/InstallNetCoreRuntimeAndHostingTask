# This pipeline is used to test the custom InstallNetCoreRuntimeAndHosting task.
#
# This pipeline:
# - provisions a server in Azure and registers it in an Azure Pipelines environment
# - install all version of the .NET Core Runtime & Hosting bundle on the server and verify that it was successful
# - unregister the server from the Azure Pipelines environment and remove the Azure resource group
# 
# The following variables need to be provided to the pipeline:
# - Token         : a Personal Access Token with the scope 'Environment (Read & manage)'.
# - AdminPassword : a password for the Admin user of the provisioned Azure server.


trigger: none


variables:
  azureSubscription: 'Azure Visual Studio Enterprise'
  resourceGroup: 'net-core-test-$(Build.BuildNumber)'
  environmentName: 'net-core-test'


stages:
- stage: 'ProvisionTestEnvironment'
  jobs:
  - job:
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Provision Azure VM'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: pscore
        scriptPath: './tests/scripts/provision-azure-vm.ps1'
        arguments:
          -ResourceGroup '$(resourceGroup)' `
          -AdminPassword '$(AdminPassword)' `
          -OrganizationUrl '$(System.CollectionUri)' `
          -TeamProject '$(System.TeamProject)' `
          -Environment '$(environmentName)' `
          -Token '$(Token)'


- stage: 'InstallNetCore'
  dependsOn: 'ProvisionTestEnvironment'
  condition: succeeded()
  jobs:
  - deployment: 'InstallNetCore'
    environment:
      name: '$(environmentName)'
      resourceType: 'VirtualMachine'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: InstallNetCoreRuntimeAndHosting@1
            inputs:
              version: '5.0'
              useProxy: false
              norestart: false
              iisReset: true