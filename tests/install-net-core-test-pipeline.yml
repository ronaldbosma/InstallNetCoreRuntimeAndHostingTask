trigger: none


variables:
  azureSubscription: 'Azure Visual Studio Enterprise'
  resourceGroup: 'net-core-test-$(Build.BuildNumber)'
  environmentName: 'net-core-test'


stages:
- stage: 'ProvisionTestEnvironment'
  jobs:
  - job:
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Provision Azure VM'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: pscore
        scriptPath: './tests/scripts/provision-azure-vm.ps1'
        arguments:
          -ResourceGroup '$(resourceGroup)' `
          -AdminPassword 'Adm!nP@ssw0rd' `
          -OrganizationUrl '$(System.CollectionUri)' `
          -TeamProject '$(System.TeamProject)' `
          -Environment '$(environmentName)' `
          -Token '$(Token)'


- stage: 'InstallNetCore'
  dependsOn: 'ProvisionTestEnvironment'
  condition: succeeded()
  jobs:
  - deployment: 'InstallNetCore'
    environment:
      name: '$(environmentName)'
      resourceType: 'VirtualMachine'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: InstallNetCoreRuntimeAndHosting@1
            inputs:
              version: '5.0'
              useProxy: false
              norestart: false
              iisReset: true